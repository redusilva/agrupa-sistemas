<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status de Serviços</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen font-sans">

    <div class="w-full max-w-2xl p-8 space-y-6 bg-gray-800 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-cyan-400">Verificador de Status de Serviços</h1>
        <div id="service-list" class="space-y-4">
        </div>
    </div>

    <script>
        const services = [
            {
                name: 'Backend Principal',
                pingUrl: 'https://final-ifg-backend.onrender.com',
                docsUrl: 'https://final-ifg-backend.onrender.com/docs'
            },
            {
                name: 'Serviço de Login',
                pingUrl: 'https://sistema-de-login-final.onrender.com',
                docsUrl: 'https://sistema-de-login-final.onrender.com/docs'
            }
        ];

        const serviceListContainer = document.getElementById('service-list');

        let serviceStatuses = [];
        let intervalIds = [];
        let restartTimeoutId = null;

        const createServiceItem = (service, index) => {
            return `
                <div id="service-${index}" class="p-4 bg-gray-700 rounded-lg flex items-center justify-between transition-all duration-300">
                  <div class="flex items-center space-x-4">
                    <div id="status-indicator-${index}" class="w-4 h-4 rounded-full"></div>
                    <span class="font-medium text-lg">${service.name}</span>
                  </div>
                  <div class="flex items-center space-x-4">
                    <span id="status-text-${index}" class="font-semibold"></span>
                    <a href="${service.docsUrl}" target="_blank" id="docs-button-${index}" class="hidden px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-md font-bold transition-colors">
                      Documentação
                    </a>
                  </div>
                </div>
            `;
        };

        const resetServiceUI = (index) => {
            const indicator = document.getElementById(`status-indicator-${index}`);
            const statusText = document.getElementById(`status-text-${index}`);
            const button = document.getElementById(`docs-button-${index}`);

            indicator.className = 'w-4 h-4 rounded-full bg-yellow-500 animate-pulse';
            statusText.textContent = 'Verificando...';
            statusText.className = 'text-yellow-400 font-semibold';
            button.classList.add('hidden');
        };

        const checkForRestart = () => {
            const allOnline = serviceStatuses.every(status => status === 'online');

            if (allOnline) {
                console.log("Todos os serviços online. Agendando nova verificação em 3 minutos.");
                restartTimeoutId = setTimeout(startAllChecks, 180000);
            }
        };

        const checkServiceStatus = async (service, index) => {
            if (serviceStatuses[index] === 'online') return;

            const indicator = document.getElementById(`status-indicator-${index}`);
            const statusText = document.getElementById(`status-text-${index}`);
            const button = document.getElementById(`docs-button-${index}`);

            try {
                await fetch(service.pingUrl, { mode: 'no-cors' });

                indicator.className = 'w-4 h-4 rounded-full bg-green-500';
                statusText.textContent = 'Online';
                statusText.className = 'text-green-400 font-semibold';
                button.classList.remove('hidden');

                serviceStatuses[index] = 'online';
                clearInterval(intervalIds[index]);
                intervalIds[index] = null;

                checkForRestart();

            } catch (error) {
                indicator.className = 'w-4 h-4 rounded-full bg-red-500';
                statusText.textContent = 'Offline';
                statusText.className = 'text-red-400 font-semibold';

                serviceStatuses[index] = 'offline';
            }
        };

        const startAllChecks = () => {
            console.log("Iniciando ciclo de verificação.");
            clearTimeout(restartTimeoutId);

            services.forEach((service, index) => {
                resetServiceUI(index);
                serviceStatuses[index] = 'checking';

                checkServiceStatus(service, index);

                if (intervalIds[index]) clearInterval(intervalIds[index]);
                intervalIds[index] = setInterval(() => checkServiceStatus(service, index), 5000);
            });
        };

        window.addEventListener('DOMContentLoaded', () => {
            if (services.length === 0) {
                serviceListContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum serviço para verificar.</p>';
                return;
            }

            services.forEach((service, index) => {
                serviceListContainer.innerHTML += createServiceItem(service, index);
            });

            startAllChecks();
        });
    </script>

</body>

</html>